

                        ┌────────────────────┐
                        │     사용자 입력       │
                        └────────┬───────────┘
                                 ↓
                        ┌────────────────────┐
                        │ MCP Message Parser │
                        └────────┬───────────┘
                                 ↓
                        ┌────────────────────┐
                        │ Plugin Manager     │ 
                        │  (Plugin as Broker)│
                        └────────┬───────────┘
                                 ↓
        ┌────────────────────────┴────────────────────────┐
        │                                                 │
┌────────────┐   ┌──────────────┐    ┌───────────────┐   ┌──────────────┐
│ Plugin: QA │   │ Plugin: Chat │    │ Plugin: Code  │   │ Plugin: Tool │ ...
│ (LLM 사용)  │   │ (LLM 사용)    │    │ (PyTorch 등)   │   │ (기타 기능)    │
└────┬───────┘   └────┬─────────┘    └────┬──────────┘   └────┬─────────┘
     ↓                ↓                   ↓                   ↓
┌─────────┐      ┌───────────────┐     ┌────────────┐     ┌──────────┐
│ LLM API │      │ Tokenizer     │     │ Local GPU  │     │ 외부 기능   │
└─────────┘      └───────────────┘     └────────────┘     └──────────┘


                    [ MCP Message Parser ]
                    ┌─────────────┐
                    │ MCPRequest  │
                    └──────┬──────┘
                           │
                           ▼
                    ┌────────────────────┐
                    │   RouterAgent      │ ◀────────────────────────────────────────────────────────────────┐
                    │  이벤트 딜리게이터      │                                                                  │
                    └──────┬─────────────┘                                                                  |
                           │                                                                                |
                           ▼                                                                                |
                    ┌─────────────────────┐                                ┌───────────────────┐            |
                    │   Selector          │                                │                   │            |
                    │    ↓                │                                │                   │            |
Planning <──────────│   [RAGSelector]     │ ← Embedding 기반 유사도 필터링      │                   │            |
   |                │    ↓                │                                │                   │             |
Planning Res───────>│  [LocalLLMSelector] │ ← Top-K description만 넘겨줌      │                  │             |
                    │    ↓                │                                 │                  │             |
                    │                     │────────────────────────────────▶│ tool_name (str)  │             |
                    └─────────────────────┘                                 └──────────────────┘             |
                        │                               ───────────────────────│                             |
                        ▼                              ▼                                                     |
                    ┌────────────────────────────────────────────┐                                           |
                    │         PluginManager.run(tool_name)       │                                           |
                    │         → BaseAgent.run(request)           │                                           |
                    └────────────────────────────────────────────┘                                           |
                        |                                                                                    |
                        ▼                                                                                    |
                    valid checker ----------------------------------------------------------------------------



                    => 


+--------------------------------------------------------+
|                        BaseAgent                       |
|--------------------------------------------------------|
| +on_event(message: AgentMessage) -> Generator[List[AgentMessage]] |
+--------------------------------------------------------+
       ↑
       ↑
+----------------+   +--------------------+   +----------------+
| PlanningAgent  |   | ToolSelectorAgent   |   | ExecutionAgent  |
|----------------|   |---------------------|   |----------------|
| - model: Model |   | - model: Model       |   | - plugin_manager: PluginManager |
+----------------+   +---------------------+   +----------------+

+--------------------------------------------------------+
|                        Model                           |
|--------------------------------------------------------|
| +ask(prompt: str, request: str, request_sender: str) -> List[AgentMessage] |
+--------------------------------------------------------+

+--------------------------------------------------------+
|                        ApiModel                        |
|--------------------------------------------------------|
| +ask(prompt: str, request: str, request_sender: str) -> List[AgentMessage] |
+--------------------------------------------------------+

+--------------------------------------------------------+
|                    PluginManager                      |
|--------------------------------------------------------|
| +run(name: str, request: MCPRequest) -> MCPResponse    |
| +load_plugin(name: str) -> BaseAgent                   |
| +list_registry() -> List[str]                          |
+--------------------------------------------------------+

+--------------------------------------------------------+
|                          Plugins (ex: CalendarPlugin)   |
|--------------------------------------------------------|
| +run(request: MCPRequest) -> MCPResponse               |
+--------------------------------------------------------+

+--------------------------------------------------------+
|                     Scheme (Data Structures)           |
|--------------------------------------------------------|
| AgentMessage                                           |
| MCPRequest                                             |
| MCPResponse                                            |
+--------------------------------------------------------+

+--------------------------------------------------------+
|                       Logging System                   |
|--------------------------------------------------------|
| +setup_logger(name: str) -> logging.Logger             |
+--------------------------------------------------------+

User Input
   ↓
Router
   ↓
PlanningAgent
   ↓
(Plan Steps with MCTS)
   ↓
Router (Select Tool)
   ↓
ToolSelectorAgent
   ↓
(Select Plugin Name)
   ↓
Router (ExecutionAgent)
   ↓
ExecutionAgent
   ↓
(Load Plugin via PluginManager → run())
   ↓
Router (User)
   ↓
User Response
